import { parseEther, parseUnits } from "ethers/lib/utils";
import { boadcastDailyData } from "./networking/socketServer";
import { MARKET_ENV } from "./environment";

export async function initDailyDataTable() {
    setInterval(async () => {
        updateDailyDataTable().then(() => {
            boadcastDailyData();
        });
    }, 24 * 60 * 60 * 1e3);
    
    await updateDailyDataTable();
}

async function updateDailyDataTable() {
    var responseJson;
    try {

        const settings = { method: "Get" };
        const refResponse = await fetch('https://api.coinbase.com/v2/exchange-rates?currency=EUR', settings);
        responseJson = await refResponse.json();
    } catch {
        console.warn('Failed to fetch coinbase price table');
        responseJson = backupTable;
    }

    const requestTable = responseJson.data.rates;
    const weth = MARKET_ENV.network.weth;

    const wethRefPrice = 1 / parseFloat(requestTable[weth.coinbaseSymbol!]);

    for (var token of MARKET_ENV.network.tokens.filter(x => x.contract != weth.contract && x.coinbaseSymbol != null)) {
        const tokenRefPrice = 1 / parseFloat(requestTable[token.coinbaseSymbol!]);
        MARKET_ENV.runtimeCache.refPriceTable[token.contract] = parseUnits((tokenRefPrice / wethRefPrice).toFixed(weth.decimals), weth.decimals).toBigInt()
    }

    MARKET_ENV.runtimeCache.refPriceTable[weth.contract] = parseEther("1").toBigInt()
}

const backupTable = {
    "data": {
        "currency": "EUR",
        "rates": {
            "AED": "4.0046854336426663",
            "AFN": "93.2850145",
            "ALL": "107.449326009438235",
            "AMD": "420.1914655",
            "ANG": "1.9552489999999999",
            "AOA": "865.9395184999939566",
            "ARS": "275.1873019999971875",
            "AWG": "1.9625429699119969",
            "AZN": "1.8534673333333333",
            "BAM": "1.9560229999999999",
            "BBD": "2.1806014661963684",
            "BDT": "117.7789950000002244",
            "BGN": "1.9558819992869287",
            "BHD": "0.4099105",
            "BIF": "3072.6617085",
            "BMD": "1.0902985",
            "BND": "1.4730352553750254",
            "BOB": "7.5267815516537774",
            "BRL": "5.2193233365971654",
            "BSD": "1.0902984824064235",
            "BTN": "89.2600035",
            "BWP": "14.5975355000000015",
            "BYN": "2.743059",
            "BYR": "27427.3999999917361244",
            "BZD": "2.1903568779701206",
            "CAD": "1.433566480662041",
            "CDF": "2581.2930502549265437",
            "CHF": "0.975926",
            "CLF": "0.0316911",
            "CLP": "874.8749435",
            "CNY": "7.8876194544348891",
            "COP": "4483.5063147757230576",
            "CRC": "588.193552000013926",
            "CUC": "1.0902985",
            "CVE": "110.2812545000004425",
            "CZK": "23.658437",
            "DJF": "193.6378728133701104",
            "DKK": "7.4470850000000008",
            "DOP": "59.955116",
            "DZD": "147.9077748554500858",
            "EGP": "33.6920010710732266",
            "ETB": "59.2676780000001701",
            "EUR": "1.0",
            "FJD": "2.4250320000000001",
            "FKP": "0.8555392154781303",
            "GBP": "0.8555928103187535",
            "GEL": "2.8618919552520619",
            "GHS": "12.5395130000000056",
            "GIP": "0.8555927999546375",
            "GMD": "64.9020924999999769",
            "GNF": "9366.8384608608263644",
            "GTQ": "8.5297030837649164",
            "GYD": "229.85812",
            "HKD": "8.5359338357700464",
            "HNL": "26.8004165366611833",
            "HRK": "7.5352494254503445",
            "HTG": "150.5163747112332028",
            "HUF": "369.39854",
            "IDR": "16393.4853804931382067",
            "ILS": "3.956312",
            "INR": "89.4149783333333333",
            "IQD": "1423.854698",
            "ISK": "148.898044634698043",
            "JMD": "167.8435320352292958",
            "JOD": "0.7733638706364147",
            "JPY": "156.0921861143582597",
            "KES": "151.7530835000011445",
            "KGS": "95.1808888608826797",
            "KHR": "4483.96509",
            "KMF": "492.545431999993397",
            "KRW": "1425.2773269999897225",
            "KWD": "0.3337126598876",
            "KYD": "0.9071876925713977",
            "KZT": "487.8934879999985193",
            "LAK": "20552.63881",
            "LBP": "16333.2839778911075057",
            "LKR": "334.976327318249017",
            "LRD": "193.8465995",
            "LSL": "20.3415435",
            "LYD": "5.204862",
            "MAD": "10.8316489999999952",
            "MDL": "19.5908478807112605",
            "MGA": "4925.465098",
            "MKD": "61.5097326137678563",
            "MMK": "2282.2318765",
            "MNT": "3800.5100340741399774",
            "MOP": "8.7787659827251668",
            "MRO": "375.9610000000035856",
            "MUR": "49.5792173138347352",
            "MVR": "16.7016899757886718",
            "MWK": "1105.8770415000071574",
            "MXN": "18.6862292095951978",
            "MYR": "5.0987934999999996",
            "MZN": "69.6457285",
            "NAD": "20.4107845167010108",
            "NGN": "825.5280389295040764",
            "NIO": "39.7491874892545317",
            "NOK": "11.7482507397589472",
            "NPR": "142.5424515",
            "NZD": "1.7704725000000001",
            "OMR": "0.419764",
            "PAB": "1.090265652960712",
            "PEN": "3.9442310000000002",
            "PGK": "3.9119019104088596",
            "PHP": "60.7288964655623124",
            "PKR": "311.7940393333323986",
            "PLN": "4.434553",
            "PYG": "7914.8035485",
            "QAR": "3.9621135000000004",
            "RON": "4.9535466439855093",
            "RSD": "117.272639147420249",
            "RUB": "92.4107740000004245",
            "RWF": "1253.1568938059553572",
            "SAR": "4.0900669241457404",
            "SBD": "9.071355360357115",
            "SCR": "15.1887980000000089",
            "SDG": "655.815843",
            "SEK": "11.6830807284996088",
            "SHP": "0.8555392100036489",
            "SKK": "30.1259999999999744",
            "SLL": "20333.6219216317372442",
            "SOS": "619.016708500006315",
            "SRD": "41.4877922020134598",
            "STD": "24757.4259633988046508",
            "SVC": "9.525068",
            "SZL": "20.3366742473600675",
            "THB": "38.4093809456141739",
            "TJS": "11.8677335",
            "TMT": "3.8160589423591192",
            "TND": "3.36887",
            "TOP": "2.570286",
            "TRY": "27.9212926007649159",
            "TTD": "7.386868",
            "TWD": "33.8449502764732919",
            "TZS": "2617.334031261637316",
            "UAH": "40.1873096666666808",
            "UGX": "4004.3777984802016826",
            "UYU": "41.1739038585956617",
            "UZS": "12466.253385",
            "VES": "29.8709182240177263",
            "VND": "25653.0665716434722509",
            "VUV": "126.4591607934193038",
            "WST": "2.978553",
            "XAF": "656.3342322843544086",
            "XAG": "0.0478408821411976",
            "XAU": "0.0005652505",
            "XCD": "2.9451989482547871",
            "XOF": "646.8146666666510756",
            "XPD": "0.000850286",
            "XPF": "119.33187099985982",
            "XPT": "0.0011706099548099",
            "YER": "272.8945746557531132",
            "ZAR": "20.3681414999999793",
            "ZMK": "5726.1599999995085122",
            "ZMW": "18.512224000000006",
            "JEP": "0.8555927999546375",
            "GGP": "0.8555393262774223",
            "IMP": "0.8555927999546375",
            "CNH": "7.8910824993338983",
            "EEK": "15.6465999999999914",
            "LTL": "3.4527999999999998",
            "LVL": "0.702804",
            "TMM": "19077.9000000061734177",
            "ZWD": "408.5940000000016001",
            "VEF": "2982060",
            "SGD": "1.4756349999999999",
            "AUD": "1.6325239992918939",
            "USD": "1.0902525606398474",
            "BTC": "0.0000358442081674",
            "BCH": "0.0056306306306306",
            "BSV": "0.03001459717335546241016974597628",
            "ETH": "0.0005758146337531",
            "ETH2": "0.0005758146337531",
            "ETC": "0.0599161174355902",
            "LTC": "0.0124339446689462",
            "ZRX": "5.3219797764768494",
            "USDC": "1.0903341874284468",
            "BAT": "5.6186088324530846",
            "LOOM": "24.72915996964472774856618166024352",
            "MANA": "2.8288543140028289",
            "KNC": "1.93995117551574269764251028771628",
            "LINK": "0.1763668430335097",
            "DNT": "38.86818398003021037677174721665064",
            "MKR": "0.00156967988919737783709891737094",
            "CVC": "13.2071782027843415893529167164658",
            "OMG": "1.64874541005975936133471086585734",
            "GNT": "5.8647931410770382136022479963682",
            "DAI": "1.090307075993647075539698480925",
            "SNT": "47.87058444082754779185169059771968",
            "ZEC": "0.0360191621942874",
            "XRP": "2.2491635635646920874702096027307",
            "REP": "0.2168726957276079",
            "XLM": "11.9357379866797164",
            "EOS": "1.4774322227967792",
            "XTZ": "1.3245033112582781",
            "ALGO": "8.1933633756657108",
            "DASH": "0.03109676442212910996559070872198",
            "ATOM": "0.1160092807424594",
            "OXT": "20.8860643800737049975517633814536",
            "COMP": "0.02997257898666246735643361957446",
            "ENJ": "3.66471448954570560027302611575714",
            "REPV2": "0.2168726957276079",
            "BAND": "0.8583690987124464",
            "NMR": "0.081366965012205",
            "CGLD": "2.2471910112359551",
            "UMA": "0.6596306068601583",
            "LRC": "4.5722481050108927994735925643853",
            "YFI": "0.00016721536807845893177877265174",
            "UNI": "0.2010050251256281",
            "BAL": "0.22666373402075829499163148427446",
            "REN": "17.12886976653334490751656165866346",
            "WBTC": "0.00003592514014607930567402853404",
            "NU": "13.64581035152265396370937079946706",
            "YFII": "0.00139548611161973005337112255058",
            "FIL": "0.2702702702702703",
            "AAVE": "0.0167560321715818",
            "BNT": "2.7972027972027972",
            "GRT": "9.8135426889106968",
            "SNX": "0.5078720162519045",
            "STORJ": "4.063058670567203",
            "SUSHI": "1.591849729385546",
            "MATIC": "1.6454134101192925",
            "SKL": "38.9105058365758755",
            "ADA": "3.7544584193730054",
            "ANKR": "43.878894251864853",
            "CRV": "1.571462245619549",
            "ICP": "0.2525252525252525",
            "NKN": "11.8906064209274673",
            "OGN": "13.49489492065660853822008827220928",
            "1INCH": "3.3557046979865772",
            "USDT": "1.0899954765187724",
            "FORTH": "0.4024144869215292",
            "CTSI": "7.21066508359687438592630157273412",
            "TRB": "0.1019880786379650996106277376303",
            "POLY": "8.4384873114539272040773042486744",
            "MIR": "25.14237188802368601087594026726216",
            "RLC": "0.7839595603939363986307751998325",
            "DOT": "0.2103049421661409",
            "SOL": "0.0643915003219575",
            "DOGE": "16.4880461665292663",
            "MLN": "0.0611658205394825",
            "GTC": "0.9605749432950197789086918315358",
            "AMP": "515.48584427415952719088511606861408",
            "SHIB": "140056.0224089635854342",
            "CHZ": "13.9082058414464534",
            "KEEP": "9.5229025807065994",
            "LPT": "0.2487562189054726",
            "QNT": "0.01029754484665739445909638240762",
            "BOND": "0.31739521416007203725505463410576",
            "RLY": "136.93242312602568032645299842595134",
            "CLV": "31.4366551398931154",
            "FARM": "0.04382924866893855826424954983344",
            "MASK": "0.3058103975535168",
            "ANT": "0.2712747199088517",
            "FET": "4.7433219953876328389846101140695",
            "PAX": "1.09085252953108954653484772119684",
            "ACH": "48.02768928613234955157898012714736",
            "ASM": "118.37704241474998913075412612572582",
            "PLA": "6.92223848025299935815712659911208",
            "RAI": "0.40156632067766020785447553508324",
            "TRIBE": "3.82175313395204683295907485342688",
            "ORN": "1.54208282975933151211761080016256",
            "IOTX": "52.938062466913711",
            "UST": "92.98529301832387204358917453564524",
            "QUICK": "0.02095229289208894527329512806762",
            "AXS": "0.1904761904761905",
            "REQ": "13.8753989177188844",
            "WLUNA": "11948.70773303853546169037839538990128",
            "TRU": "25.74002574002574",
            "RAD": "0.6629101756711966",
            "COTI": "21.6105562069345371503830169980596",
            "DDX": "3.5198873636043647",
            "SUKU": "19.7628458498023715",
            "RGT": "2.96482480450304712125311157714144",
            "XYO": "295.0287653046172002",
            "ZEN": "0.15248287561396471478629087865126",
            "AST": "10.17501223182312080971849226435402",
            "AUCTION": "0.2728512960436562",
            "BUSD": "1.0903230243133521912951136696077",
            "JASMY": "244.17750518249661816600352994070872",
            "WCFG": "4.3927081045464529",
            "BTRST": "2.0618556701030928",
            "AGLD": "2.32711325643510651991261633871368",
            "AVAX": "0.0813008130081301",
            "FX": "7.10493685656466207671357011573676",
            "TRAC": "4.222972972972973",
            "LCX": "15.3374233128834356",
            "ARPA": "18.8005264147396127",
            "BADGER": "0.4819277108433735",
            "KRL": "4.4953922229714543",
            "PERP": "2.1588946459412781",
            "RARI": "0.9433962264150943",
            "DESO": "0.12647941538745329820499671669556",
            "API3": "1.04480360387143979476663697859548",
            "NCT": "110.2535832414553473",
            "SHPING": "363.1741420010895224",
            "UPI": "682.55749822064740521448840140359206",
            "CRO": "18.8857412653446648",
            "MTL": "0.81943071074020853365051813581694",
            "ABT": "13.21518255321027150193633259830488",
            "CVX": "0.29131664946956508489614859560448",
            "AVT": "1.0848284185471117892666700195097",
            "MDT": "25.90288811213702538042616817153916",
            "VGX": "8.378718056137411",
            "ALCX": "0.0701016473887136",
            "COVAL": "124.81425994732082423142261933844618",
            "FOX": "51.9167886018974951861784494933406",
            "MUSD": "1.09392696276354349420242490054138",
            "CELR": "63.98195778402860332835714083214436",
            "GALA": "41.2878044124468055328654389492261",
            "POWR": "7.4404761904761905",
            "GYEN": "155.3619609034339009179912578011034",
            "ALICE": "1.04983395343268883887341512184662",
            "INV": "0.0253046898140848632767348723349",
            "LQTY": "1.1145786892554614",
            "PRO": "3.94733005300451632506763613205048",
            "SPELL": "2250.7278295620301404136122799537525",
            "ENS": "0.1224739742804654",
            "DIA": "3.8426068244697203",
            "BLZ": "18.81367662881531322154228284896348",
            "CTX": "0.9478672985781991",
            "ERN": "0.7326007326007326",
            "IDEX": "17.7421083912098845130231132620266",
            "MCO2": "0.90477390924468667157601011040208",
            "POLS": "3.4419970343799444051270987350319",
            "SUPER": "9.67651158817651012461509936611446",
            "UNFI": "0.31061326513955766350705055252426",
            "STX": "1.409870115918592265498186265822",
            "KSM": "0.04348833508734936252888421286332",
            "GODS": "6.88399406875988891927945353404854",
            "IMX": "1.49237226834555798914057092098384",
            "RBN": "5.99748362428059196173367883384302",
            "BICO": "4.1657987919183503",
            "GFI": "3.28290442830426794308030617088062",
            "ATA": "11.14208033357023398243314953471512",
            "GLM": "5.89325708453971566978241859113596",
            "MPL": "0.15653303096049491324389471453928",
            "PLU": "0.1069924004553334406068052022718",
            "SWFTC": "738.1533924440402167077914230233102",
            "SAND": "2.52577912808953410409239124121616",
            "OCEAN": "3.21893286282801117394902972947078",
            "GNO": "0.00939387007271973657307233937126",
            "FIDA": "4.3393360815795183",
            "ORCA": "1.97885935318966763512096181351756",
            "CRPT": "19.34787152865745168989585450931",
            "QSP": "92.43345151673144549453617672318566",
            "RNDR": "0.5266622778143515",
            "NEST": "86.25415827846893988169812071372036",
            "PRQ": "11.10236823462166399486349377719958",
            "HOPR": "22.92855017118501363588698654580496",
            "JUP": "177.58002453617516084369915705577588",
            "MATH": "12.73659533457765653390465375222544",
            "SYN": "1.60685712695629679276116606142322",
            "AIOZ": "76.50895162384894038339349742259194",
            "WAMPL": "0.26689169171110098233565239320054",
            "AERGO": "10.72028083225022026133563281356066",
            "INDEX": "0.83544257520294824351217296085204",
            "TONE": "106.5219893150803517494246204094947",
            "HIGH": "0.80999447298651363157799265493556",
            "GUSD": "1.0902525606398474",
            "FLOW": "1.99314910537449255479774136768584",
            "ROSE": "21.48916055267265990518305025820202",
            "OP": "0.81029547427710689613674854120102",
            "APE": "0.4496402877697842",
            "MINA": "2.2099447513812155",
            "MUSE": "0.21341931303510765434532595764876",
            "SYLO": "688.72555946926557174593183724277806",
            "CBETH": "0.00055397041804400694277865098614",
            "DREP": "3.6214999522997754049599030977778",
            "ELA": "0.79175930329691169770573215725702",
            "FORT": "8.35442575202948199902070535258144",
            "ALEPH": "14.0587048438407143521636244594749",
            "DEXT": "1.96441902817990522326080619704532",
            "FIS": "3.62631817941076798532710048275912",
            "BIT": "2.5497019659491285805182540806049",
            "GMT": "4.71460566763177251402088366011182",
            "GST": "82.4668174910061949084267330581226",
            "MEDIA": "0.1346822187325321523670786929151",
            "C98": "6.91784619695334645832248922509482",
            "ARB": "0.95160387591851919181349122103262",
            "TIME": "0.05693224859738110313409675328974",
            "RPL": "0.0286757643513900350736867810983",
            "MXC": "83.0352292947332369032501917377551",
            "HBAR": "21.43634606055539521186295942664124",
            "KAVA": "1.0537404539118034519556167538725",
            "SPA": "184.86690303346289109809760951035606",
            "EGLD": "0.03211347748570984096594976725072",
            "GHST": "1.10349449457474438539293920543382",
            "NEAR": "0.69178461969533461312467210331406",
            "INJ": "0.15050421875204963532643177870042",
            "AUDIO": "5.65630381654914345204455717885316",
            "MONA": "0.00343879436874845540366187215982",
            "TVK": "39.5377175209373490821520519873751",
            "POND": "138.26918968165471150735504795157984",
            "DYP": "7.35142146684095209473308274515534",
            "LDO": "0.56025311440896582558909397363334",
            "LIT": "1.559062720777702558143496981782",
            "XMON": "0.0006044460618985439914129665121",
            "ILV": "0.02315007029705588150136847334648",
            "PUNDIX": "2.9570180652016474188371855436711",
            "PYR": "0.3437113999495105784413189189339",
            "PNG": "40.04600773700082281243149713230672",
            "METIS": "0.05313121640545068022462529471744",
            "RARE": "15.18457605347976881073177484621608",
            "QI": "171.78800293702787358581759623465032",
            "MSOL": "0.05750277218564598797696464094122",
            "OSMO": "2.16041327779619024897893388243004",
            "XCN": "868.72713995206964138517986479987938",
            "DAR": "9.95664438940499907232085650294266",
            "MAGIC": "1.2683992329007590073208058155818",
            "AURORA": "11.41625717947484189280813395233396",
            "BOBA": "7.8633433872329419257864340197063",
            "VOXEL": "7.73777544811815047192083753070682",
            "OOKI": "428.0536162700617981973780999156336",
            "MULTI": "0.29776118001907621551325496974496",
            "LOKA": "4.3758882626524077676576921101692",
            "T": "45.69373682480500414002923877638938",
            "MNDE": "17.60885989889117981580215006766694",
            "STG": "1.79660622515079308484368969706664",
            "GAL": "0.82035557610221777461189070668236",
            "00": "10.51352517492620447298545360712306",
            "HFT": "2.809205258025888715169799861063",
            "DIMO": "8.38204475005648806315499405761196",
            "EUROC": "1.0005002501250625",
            "BLUR": "3.12169666611266252774925593371426",
            "APT": "0.14595081133063547609355095167538",
            "WAXL": "2.67941155232206294896394132459388",
            "LSETH": "0.0005701695524891192675272063592",
            "SUI": "1.46983830217707777260770320755336",
            "AXL": "2.6777663284780729662388567329359",
            "ACS": "302.46145498525423065383390668859666",
            "FLR": "66.86614907328104267183483870030868",
            "PRIME": "0.61910991518446752224553140785296"
        }
    }
}